WITH scheduled_by_month AS
(
    SELECT
        CAST(DATE_TRUNC('month', due_date) AS date) AS year_month,
        SUM(due_principal + due_fee_interest)      AS scheduled_cash_flow
    FROM cica_prime.payment_schedule
    GROUP BY 1
),

actual_by_month AS
(
    SELECT
        CAST(DATE_TRUNC('month', payment_date) AS date) AS year_month,
        SUM(payment_amount)                             AS actual_cash_flow
    FROM cica_prime.payments
    GROUP BY 1
),

calendar AS
(
    SELECT
        month_start AS year_month
    FROM cica_prime.dim_month
),

final AS
(
    SELECT
        c.year_month,
        COALESCE(s.scheduled_cash_flow, 0) AS scheduled_cash_flow,
        COALESCE(a.actual_cash_flow, 0)    AS actual_cash_flow,
        COALESCE(a.actual_cash_flow, 0) - COALESCE(s.scheduled_cash_flow, 0) AS cashflow_gap
    FROM calendar c
    LEFT JOIN scheduled_by_month s
        ON c.year_month = s.year_month
    LEFT JOIN actual_by_month a
        ON c.year_month = a.year_month
)

SELECT *
FROM final
ORDER BY year_month;
