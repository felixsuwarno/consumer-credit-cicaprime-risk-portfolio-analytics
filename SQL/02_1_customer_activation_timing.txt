-- left join loan and customer table
-- because we only want customers who made a loan and ignore those
-- who dont loan anything.

-- make sure we only get each customer's earliest loan

-- make sure that the activation day is not minus,
-- meaning origination date has to be on the same day as the signup_date
-- OR later than the signup_date

with activation_table AS
(
	SELECT
		l.customer_id,
		signup_date, 
		MIN(origination_date) as origination_date
	FROM loans l
	LEFT JOIN customers c
	ON l.customer_id = c.customer_id
	WHERE l.origination_date::date >= c.signup_date::date
	GROUP BY l.customer_id, c.signup_date
	ORDER BY l.customer_id, signup_date
),

-- create a new column, and calculate activation days
activation_day AS
(
	SELECT 
		customer_id, 
		signup_date, 
		origination_date,
		(origination_date - signup_date) AS activation_days
	FROM activation_table
)

SELECT 
	DATE_TRUNC('month',signup_date)::date AS year_month,
	ROUND(AVG(activation_days),2) AS avg_activation_days,
	PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY activation_days) AS median_activation_days
	
FROM activation_day
GROUP BY DATE_TRUNC('month',signup_date)
ORDER BY year_month


