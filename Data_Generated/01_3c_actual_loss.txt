WITH defaulted_loans AS
(
    SELECT *
    FROM loans
    WHERE default_date IS NOT NULL
),

defaulted_loan_and_payments AS
(
    SELECT 
        dl.loan_id,
        dl.default_date,
        dl.principal,
        p.payment_date,
        p.payment_type,
        p.paid_principal
    FROM defaulted_loans dl
    LEFT JOIN payments p
        ON dl.loan_id = p.loan_id
       AND p.payment_date <= dl.default_date
),

defaulted_loan_principal_paid AS
(
    SELECT
        loan_id,
        default_date,
        principal,
        COALESCE
		(
            SUM
			(
                CASE
                    WHEN payment_type IN ('scheduled','partial')
                    THEN paid_principal
                    ELSE 0
                END
            ),
            0
        ) AS principal_paid_pre_default
    FROM defaulted_loan_and_payments
    GROUP BY 1,2,3
),

monthly_principal_loss AS
(
    SELECT
        DATE_TRUNC('month', default_date)::date AS year_month,
        SUM(principal - principal_paid_pre_default) AS actual_loss_unpaid_principal
    FROM defaulted_loan_principal_paid
    GROUP BY 1
),

monthly_principal_unpaid AS
(
    SELECT
        dm.month_start AS year_month,
        COALESCE(mpl.actual_loss_unpaid_principal, 0) AS actual_loss_unpaid_principal
    FROM dim_month dm
    LEFT JOIN monthly_principal_loss mpl
        ON dm.month_start = mpl.year_month
),

monthly_recoveries AS
(
    SELECT
        DATE_TRUNC('month', payment_date)::date AS year_month,
        SUM(payment_amount) AS actual_loss_recovered_principal
    FROM payments
    WHERE payment_type = 'recovery'
    GROUP BY 1
),

monthly_net_loss AS
(
    SELECT
        mpu.year_month,
        mpu.actual_loss_unpaid_principal
        - COALESCE(mr.actual_loss_recovered_principal, 0) AS actual_loss
    FROM monthly_principal_unpaid mpu
    LEFT JOIN monthly_recoveries mr
        ON mpu.year_month = mr.year_month
)

SELECT *
FROM monthly_net_loss
ORDER BY year_month;
